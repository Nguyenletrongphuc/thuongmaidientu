<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="asset/giohang.css"> 
    <script src="asset/script.js"></script>
    <link rel="stylesheet" href="asset/img/themify-icons-font/themify-icons/themify-icons.css">
    <script src="asset/dongbodangnhap.js"></script>
    <title>Giỏ Hàng</title>
</head>
<body>
    <header class="header">
        <div class="grid">
            <nav class="header__navbar ">
                <ul class="header__nav-list">
                    <li class="header__nav-item phancach">Vào cửa hàng trên ứng dụng</li>
                    <li class="header__nav-item">Kết nối
                        <a href="https://facebook.com" class="nav-item__icon">
                            <i class="ti-facebook"></i>
                        </a>
                        <a href="https://instagram.com" class="nav-item__icon">
                            <i class="ti-instagram"></i>
                        </a>
                    </li>
                    <li class="header__nav-item hearder__thongbao__hien">
                        <a href="" class="nav-item__icon">
                            <i class="ti-bell"></i>
                            Thông báo
                        </a>
                        <div class="hearder_thongbao">
                            <header class="hearder_thongbao-head">
                                <h3>Thông Báo Mới</h3>
                            </header>
                            <ul class="hearder_thongbao_list">
                                <li class="hearder_thongbao_list_item">
                                    <a href="" class="hearder_thongbao_link">
                                        <img src="https://ischool.vn/wp-content/uploads/2022/12/nhung-cuon-sach-hay-cho-tre-10-tuoi-3.jpg" alt="">
                                    <div class="hearder_thongbao_info">
                                        <p class="hearder_thongbao_name">Sách trẻ em</p>
                                        <p class="hearder_thongbao_mota">Phù hợp cho tuổi 5-10</p>
                                    </div>
                                    </a>
                                </li>
                            </ul>
                            <footer class="hearder_thongbao-footer">
                                <a href="" class="hearder_thongbao-footer-btn">Xem tất cả</a>
                            </footer>
                        </div>
                    </li>
                    <li class="header__nav-item">
                        <a href="" class="nav-item__icon">
                            <i class="ti-help-alt"></i>
                            Trợ giúp
                        </a>
                    </li>
                </ul>
                <ul class="header__nav-list">
                    <li class="header__nav_user_btn">
                        <button class="signup custom-btn btn-9">
                         <a href="signup.html">Đăng Nhập/Đăng Ký</a>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
        <!-- phan tim kiem -->
        <div class="grid__timkiem">
            <div class="header__logo">
                <a href="index.html" class="header__logo-link">
                    <!-- <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fe/Shopee.svg/1200px-Shopee.svg.png" alt="" class="header__logo-img"> -->
                    <img src="asset/img/logosachoi.png" alt="" class="header__logo-img">
                </a>
            </div>
            <div class="header__search">
                <input type="text" class="header__search-input" placeholder="Tìm kiếm sản phẩm">
                <button class="header__search-btn">
                    <i class="ti-search"></i>
                </button>
            </div>
            
    </header>
    <div class="shopping-cart">
        <div class="cart-header">
          <h1>GIỎ HÀNG CỦA BẠN</h1>
          <!-- <div class="cart-summary">1 sản phẩm</div> -->
        </div>
      
        <div class="cart-items">
          <div class="cart-item">
            <div class="item-select">
              <input type="checkbox" checked>
            </div>
            
            <div class="item-image">
              <img src="https://cdn1.fahasa.com/media/catalog/product/9/7/9786043561272_1_1.jpg" alt="Veil - Tập 6 - Sắc Đồ Tung Bay">
            </div>
            
            <div class="item-info">
              <h3 class="item-title">Veil - Tập 6 - Sắc Đồ Tung Bay - Tặng Kèm Postcard</h3>
              <div class="item-price">59.500 ₫</div>
              
              <div class="item-quantity">
                <button class="decrease">-</button>
                <input type="number" value="1" min="1">
                <button class="increase">+</button>
              </div>
            </div>
            
            <div class="item-total">
              <div class="total-price">59.500 ₫</div>
              <button class="remove-item">Xóa</button>
            </div>
          </div>
        </div>
      
        <div class="cart-summary-section">
          <div class="summary-details">
            <div class="summary-row">
              <span>Giảm giá:</span>
              <span>0 ₫</span>
            </div>
            <div class="summary-row total">
              <span>Tổng tiền:</span>
              <span class="grand-total">0 ₫</span>
            </div>
          </div>
          <div class="summary-actions">
            <a href="checkout.html" class="checkout-btn" >TIẾN HÀNH ĐẶT HÀNG</a>
          </div>
          
          
          <div class="continue-shopping">
            <a href="/index.html">← Tiếp tục mua hàng</a>
          </div>
        </div>
      </div>
      <script>
        document.addEventListener("DOMContentLoaded", () => {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const cartItemsContainer = document.querySelector(".cart-items");

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = "<img src='https://tuongvip.vn/public/assets/frontend/img/cart_empty_icon.png' alt='Giỏ hàng trống' class='empty-cart'>";
                document.querySelector(".grand-total").textContent = "0 ₫"; // Đặt tổng tiền về 0 nếu giỏ hàng trống
                return;
            }

            // Hiển thị danh sách sản phẩm trong giỏ hàng
            cartItemsContainer.innerHTML = cart.map(item => `
                <div class="cart-item" data-id="${item._id}" data-stock="${item.quantity}">
                    <div class="item-select">
                        <input type="checkbox" checked>
                    </div>
                    <div class="item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="item-info">
                        <h3 class="item-title">${item.name}</h3>
                        <div class="item-price">${item.price.toLocaleString()} ₫</div>
                        <div class="item-quantity">
                            <button class="decrease">-</button>
                            <input type="number" value="${item.cartQuantity}" min="1">
                            <button class="increase">+</button>
                        </div>
                    </div>
                    <div class="item-total">
                        <div class="total-price">${(item.price * item.cartQuantity).toLocaleString()} ₫</div>
                        <button class="remove-item">Xóa</button>
                    </div>
                </div>
            `).join("");

            // Tính tổng tiền ngay khi trang được load
            calculateTotal();

            // Các sự kiện khác (tăng/giảm số lượng, thay đổi số lượng, xóa sản phẩm, ...)
            cartItemsContainer.addEventListener("click", (e) => {
                const target = e.target;

                // Xử lý nút tăng/giảm số lượng
                if (target.classList.contains("increase") || target.classList.contains("decrease")) {
                    const cartItem = target.closest(".cart-item");
                    const input = cartItem.querySelector("input[type='number']");
                    const current = parseInt(input.value);
                    const stock = parseInt(cartItem.dataset.stock);

                    if (target.classList.contains("increase")) {
                        if (current < stock) {
                            input.value = current + 1;
                            updateCartQuantity(cartItem.dataset.id, current + 1);
                            updateItemTotal(cartItem); // Cập nhật giá tiền ngay lập tức
                            calculateTotal(); // Cập nhật tổng tiền
                        } else {
                            alert("Vượt quá số lượng tồn kho!");
                        }
                    }

                    if (target.classList.contains("decrease")) {
                        if (current > 1) {
                            input.value = current - 1;
                            updateCartQuantity(cartItem.dataset.id, current - 1);
                            updateItemTotal(cartItem); // Cập nhật giá tiền ngay lập tức
                            calculateTotal(); // Cập nhật tổng tiền
                        }
                    }
                }

                // Xử lý nút xóa sản phẩm
                if (target.classList.contains("remove-item")) {
                    const cartItem = target.closest(".cart-item");
                    const productId = cartItem.dataset.id;

                    // Xóa sản phẩm khỏi localStorage
                    const cart = JSON.parse(localStorage.getItem("cart")) || [];
                    const updatedCart = cart.filter(item => item._id !== productId);
                    localStorage.setItem("cart", JSON.stringify(updatedCart));

                    // Xóa sản phẩm khỏi giao diện
                    cartItem.remove();

                    // Cập nhật tổng tiền
                    calculateTotal();
                }
            });

            cartItemsContainer.addEventListener("change", (e) => {
                if (e.target.matches("input[type='number']")) {
                    const input = e.target;
                    const cartItem = input.closest(".cart-item");
                    const stock = parseInt(cartItem.dataset.stock);

                    let value = parseInt(input.value);

                    if (value > stock) {
                        alert("Số lượng vượt quá tồn kho!");
                        value = stock;
                    } else if (value < 1 || isNaN(value)) {
                        value = 1;
                    }

                    input.value = value;
                    updateCartQuantity(cartItem.dataset.id, value);
                    updateItemTotal(cartItem); // Cập nhật giá tiền ngay lập tức
                    calculateTotal(); // Cập nhật tổng tiền
                }
            });

            function updateCartQuantity(productId, newQuantity) {
                const cart = JSON.parse(localStorage.getItem("cart")) || [];
                const item = cart.find(i => i._id === productId);
                if (item) {
                    item.cartQuantity = newQuantity;
                    localStorage.setItem("cart", JSON.stringify(cart));
                }
            }

            function updateItemTotal(cartItem) {
                const input = cartItem.querySelector("input[type='number']");
                const quantity = parseInt(input.value);
                const priceStr = cartItem.querySelector(".item-price").textContent;
                const price = parseCurrency(priceStr);
                const totalPriceElement = cartItem.querySelector(".total-price");

                totalPriceElement.textContent = formatCurrency(price * quantity);
            }

            function calculateTotal() {
                let total = 0;
                const items = cartItemsContainer.querySelectorAll(".cart-item");

                items.forEach(item => {
                    const isChecked = item.querySelector("input[type='checkbox']").checked;

                    if (isChecked) {
                        const quantity = parseInt(item.querySelector("input[type='number']").value);
                        const priceStr = item.querySelector(".item-price").textContent;
                        const price = parseCurrency(priceStr);
                        total += price * quantity;
                    }
                });

                document.querySelector(".grand-total").textContent = formatCurrency(total);
            }

            function parseCurrency(value) {
                return parseInt(value.replace(/[^\d]/g, ""));
            }

            function formatCurrency(value) {
                return value.toLocaleString("vi-VN") + " ₫";
            }
            
        });
        </script>
</body>
</html>